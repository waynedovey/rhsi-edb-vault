apiVersion: batch/v1
kind: Job
metadata:
  name: skupper-local-ca-configmap
  namespace: rhsi
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    metadata:
      name: skupper-local-ca-configmap
    spec:
      restartPolicy: OnFailure
      containers:
      - name: create-skupper-local-ca-configmap
        image: quay.io/openshift/origin-cli:4.15
        command: ["/bin/bash", "-c"]
        args:
        - |
          set -euo pipefail
          echo "Ensuring skupper-local-ca ConfigMap exists in namespace ${KUBERNETES_NAMESPACE:-rhsi}..."
          NS="${KUBERNETES_NAMESPACE:-rhsi}"

          if oc -n "${NS}" get configmap skupper-local-ca >/dev/null 2>&1; then
            echo "ConfigMap skupper-local-ca already exists, nothing to do."
            exit 0
          fi

          echo "Waiting for secret skupper-local-ca to be created..."
          for i in $(seq 1 30); do
            if oc -n "${NS}" get secret skupper-local-ca >/dev/null 2>&1; then
              break
            fi
            echo "  [${i}/30] Secret skupper-local-ca not found yet, sleeping 10s..."
            sleep 10
          done

          if ! oc -n "${NS}" get secret skupper-local-ca >/dev/null 2>&1; then
            echo "ERROR: Secret skupper-local-ca was not found after waiting."
            exit 1
          fi

          echo "Creating ConfigMap skupper-local-ca from secret skupper-local-ca (tls.crt)..."
          oc -n "${NS}" get secret skupper-local-ca -o jsonpath='{.data.tls\.crt}' | base64 -d > /tmp/ca.crt

          oc -n "${NS}" create configmap skupper-local-ca             --from-file=ca.crt=/tmp/ca.crt             -o yaml --dry-run=client | oc -n "${NS}" apply -f -

          echo "ConfigMap skupper-local-ca created/updated successfully."
