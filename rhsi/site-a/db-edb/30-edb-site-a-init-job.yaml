apiVersion: batch/v1
kind: Job
metadata:
  name: edb-site-a-init
  namespace: db
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: init
          image: registry.access.redhat.com/ubi9/ubi-minimal:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              microdnf install -y postgresql &&                   export PGPASSWORD="${PGPASSWORD}" &&                   psql "host=edb-site-a-rw.db.svc.cluster.local dbname=postgres user=postgres" <<'SQL'
              CREATE TABLE IF NOT EXISTS site_a_data (
                id         serial PRIMARY KEY,
                site       text DEFAULT 'site-a',
                payload    text,
                created_at timestamptz DEFAULT now()
              );
              SQL
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: edb-site-a-superuser
                  key: password

