apiVersion: batch/v1
kind: Job
metadata:
  name: skupper-local-ca-configmap
  namespace: rhsi
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    metadata:
      name: skupper-local-ca-configmap
    spec:
      restartPolicy: OnFailure
      containers:
      - name: create-skupper-local-ca-configmap
        image: quay.io/openshift/origin-cli:4.15
        command:
        - /bin/bash
        - -c
        args:
        - "set -euo pipefail\necho \"Ensuring skupper-local-ca ConfigMap exists in\
          \ namespace ${KUBERNETES_NAMESPACE:-rhsi}...\"\nNS=\"${KUBERNETES_NAMESPACE:-rhsi}\"\
          \n\n# If the ConfigMap already exists, exit successfully (idempotent).\n\
          if oc -n \"${NS}\" get configmap skupper-local-ca >/dev/null 2>&1; then\n\
          \  echo \"ConfigMap skupper-local-ca already exists, nothing to do.\"\n\
          \  exit 0\nfi\n\n# Wait for the secret created by the Certificate CRD to\
          \ be present.\necho \"Waiting for secret skupper-local-ca to be created...\"\
          \nfor i in $(seq 1 30); do\n  if oc -n \"${NS}\" get secret skupper-local-ca\
          \ >/dev/null 2>&1; then\n    break\n  fi\n  echo \"  [${i}/30] Secret skupper-local-ca\
          \ not found yet, sleeping 10s...\"\n  sleep 10\ndone\n\nif ! oc -n \"${NS}\"\
          \ get secret skupper-local-ca >/dev/null 2>&1; then\n  echo \"ERROR: Secret\
          \ skupper-local-ca was not found after waiting.\"\n  exit 1\nfi\n\n# Extract\
          \ the tls.crt from the secret and create a ConfigMap from it.\necho \"Creating\
          \ ConfigMap skupper-local-ca from secret skupper-local-ca (tls.crt)...\"\
          \noc -n \"${NS}\" get secret skupper-local-ca -o jsonpath='{.data.tls\\\
          .crt}' | base64 -d > /tmp/ca.crt\n\noc -n \"${NS}\" create configmap skupper-local-ca\
          \             --from-file=ca.crt=/tmp/ca.crt             -o yaml --dry-run=client\
          \ | oc -n \"${NS}\" apply -f -\n\necho \"ConfigMap skupper-local-ca created/updated\
          \ successfully.\"\n"
      serviceAccountName: skupper-local-ca-configmap
